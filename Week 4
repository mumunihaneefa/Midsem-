#include <iostream>
#include <fstream>
#include <vector>
#include <string>

using namespace std;

// ================= STRUCTS =================

struct Student {
    string id;
    string name;
};

struct AttendanceSession {
    string name;
    vector<string> presentIDs;
};

// ================= GLOBAL VECTORS =================

vector<Student> students;
vector<AttendanceSession> sessions;

// ================= STUDENT FUNCTIONS =================

void loadStudents() {
    ifstream file("students.txt");
    if (!file) return;

    Student s;
    while (getline(file, s.id) && getline(file, s.name)) {
        students.push_back(s);
    }
    file.close();
}

void saveStudents() {
    ofstream file("students.txt");
    for (const auto& s : students) {
        file << s.id << endl;
        file << s.name << endl;
    }
    file.close();
}

void registerStudent() {
    Student s;
    cout << "Enter Student ID: ";
    getline(cin, s.id);
    cout << "Enter Student Name: ";
    getline(cin, s.name);
    students.push_back(s);
    cout << "Student Registered Successfully!\n";
}

void viewStudents() {
    if (students.empty()) {
        cout << "No students registered.\n";
        return;
    }
    cout << "\n--- Student List ---\n";
    for (size_t i = 0; i < students.size(); i++) {
        cout << i + 1 << ". ID: " << students[i].id
             << ", Name: " << students[i].name << endl;
    }
}

bool studentExists(string id) {
    for (const auto& s : students) {
        if (s.id == id) return true;
    }
    return false;
}

// ================= SESSION FUNCTIONS =================

void loadSessions() {
    ifstream file("sessions.txt");
    if (!file) return;

    AttendanceSession s;
    string line;
    while (getline(file, s.name)) {
        int n;
        file >> n;
        file.ignore();
        s.presentIDs.clear();
        for (int i = 0; i < n; i++) {
            string id;
            getline(file, id);
            s.presentIDs.push_back(id);
        }
        sessions.push_back(s);
    }
    file.close();
}

void saveSessions() {
    ofstream file("sessions.txt");
    for (const auto& s : sessions) {
        file << s.name << endl;
        file << s.presentIDs.size() << endl;
        for (const auto& id : s.presentIDs) {
            file << id << endl;
        }
    }
    file.close();
}

void createSession() {
    AttendanceSession s;
    cout << "Enter Session Name: ";
    getline(cin, s.name);
    sessions.push_back(s);
    cout << "Session Created Successfully!\n";
}

void viewSessions() {
    if (sessions.empty()) {
        cout << "No sessions available.\n";
        return;
    }
    cout << "\n--- Lecture Sessions ---\n";
    for (size_t i = 0; i < sessions.size(); i++) {
        cout << i + 1 << ". " << sessions[i].name << endl;
    }
}

// ================= ATTENDANCE FUNCTIONS =================

void markAttendance() {
    if (sessions.empty()) {
        cout << "No sessions available.\n";
        return;
    }
    viewSessions();
    int choice;
    cout << "Select session number: ";
    cin >> choice;
    cin.ignore();
    if (choice < 1 || choice > sessions.size()) {
        cout << "Invalid session choice.\n";
        return;
    }

    string id;
    cout << "Enter Student ID to mark present: ";
    getline(cin, id);
    if (!studentExists(id)) {
        cout << "Student not found.\n";
        return;
    }

    // prevent duplicate attendance
    for (const auto& presentID : sessions[choice - 1].presentIDs) {
        if (presentID == id) {
            cout << "Student already marked present.\n";
            return;
        }
    }

    sessions[choice - 1].presentIDs.push_back(id);
    cout << "Attendance Marked Successfully!\n";
}

void generateReport() {
    if (sessions.empty()) {
        cout << "No sessions available.\n";
        return;
    }
    viewSessions();
    int choice;
    cout << "Select session number: ";
    cin >> choice;
    cin.ignore();
    if (choice < 1 || choice > sessions.size()) {
        cout << "Invalid session choice.\n";
        return;
    }

    AttendanceSession& session = sessions[choice - 1];
    cout << "\n--- Attendance Report ---\n";
    cout << "Session: " << session.name << endl;
    cout << "Total Present: " << session.presentIDs.size() << endl;
    for (const auto& id : session.presentIDs) {
        cout << "Student ID: " << id << endl;
    }
}

// ================= MAIN MENU =================

int main() {
    loadStudents();
    loadSessions();

    int choice;
    do {
        cout << "\n--- Digital Attendance System (Week 4) ---\n";
        cout << "1. Register Student\n";
        cout << "2. View Students\n";
        cout << "3. Create Session\n";
        cout << "4. View Sessions\n";
        cout << "5. Mark Attendance\n";
        cout << "6. Generate Report\n";
        cout << "7. Save & Exit\n";
        cout << "Choice: ";
        cin >> choice;
        cin.ignore();

        switch (choice) {
            case 1: registerStudent(); break;
            case 2: viewStudents(); break;
            case 3: createSession(); break;
            case 4: viewSessions(); break;
            case 5: markAttendance(); break;
            case 6: generateReport(); break;
            case 7:
                saveStudents();
                saveSessions();
                cout << "Data Saved. Exiting...\n";
                break;
            default: cout << "Invalid choice.\n";
        }

    } while (choice != 7);

    return 0;
}
